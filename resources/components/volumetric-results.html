<link rel="import" href="/resources/bower_components/polymer/polymer-element.html">
<link rel="import" href="/resources/bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="/resources/bower_components/paper-card/paper-card.html">
<link rel="import" href="/resources/bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="/resources/bower_components/vaadin-grid/vaadin-grid-sorter.html">

<dom-module id="volumetric-results">
    <template>
    <style>
      :host {
          display: block;

          padding: 10px;
      }

      paper-card {
          width: 100%;
      }

      .constrained {
          width: 100%;
          overflow: auto;
      }
    </style>

        <iron-ajax id="getResultMetadata" url="/api/results/metadata" last-response="{{metadata}}"></iron-ajax>
        <iron-ajax id="getResultPage" url="/api/results/get?job_id=[[jobId]]"></iron-ajax>

        <paper-card id="displayCard" heading="Processing...">
            <iron-pages id="resultView" selected="0">
                <div class="constrained">
                    <table>
                        <tr>
                            <template is="dom-repeat" items="[[partialColumns]]">
                                <th>{{getColumnName(item)}}</th>
                            </template>
                        </tr>
                        <template is="dom-repeat" items="[[partialData]]">
                            <tr>
                                <template is="dom-repeat" items="[[item]]" as="dataval">
                                    <td>{{dataval}}</td>
                                </template>
                            </tr>
                        </template>
                    </table>
                </div>
                <vaadin-grid id="grid">
                    <template is="dom-repeat" items="[[getColumns(metadata)]]" as="column">
                        <vaadin-grid-column>
                            <template class="header">
                                <vaadin-grid-sorter path="[[column]]">[[column]]</vaadin-grid-sorter>
                            </template>
                            <template>[[getItem(column,item)]]</template>
                        </vaadin-grid-column>
                    </template>
                </vaadin-grid>
            </iron-pages>
        </paper-card>

    </template>

    <script>
    class VolumetricResults extends Polymer.Element {
        static get is() {
            return 'volumetric-results';
        }

        static get properties() {
            return {
                'partialColumns': {
                    type: Object,
                    notify: true,
                    value: []
                },
                'partialData': {
                    type: Object,
                    notify: true,
                    value: []
                },
                'page': {
                    type: String,
                    notify: true
                },
                'jobId': {
                    type: String,
                    notify: true
                }
            }
        }

        getColumns(metadata) {
            let result = [];
            for (let index = 0; index < this.metadata.columns.length; index++) {
                result.push(this.metadata.columns[index].name);
            }
            return result;
        }

        getColumnName(item) {
            return item[1];
        }

        addPartialData(data) {
            return this.push('partialData', data);
        }

        buildGrid() {
            this.$.resultView.selected = 1;
            let getResultPage = this.$.getResultPage;
            let getResultMetadata = this.$.getResultMetadata;
            let grid = this.$.grid;
            let displayCard = this.$.displayCard;

            getResultMetadata.params = {'job_id': this.jobId};
            getResultMetadata.addEventListener('response', function() {
                grid.size = getResultMetadata.lastResponse.size;
                getResultPage.generateRequest();
            }, {once: true});

            grid.size = 0;
            grid.dataProvider = function(params, callback) {
                getResultPage.addEventListener('response', function() {
                    if (getResultPage.lastResponse != undefined && getResultPage.lastResponse != null) {
                        displayCard.heading = "Results";
                        callback(getResultPage.lastResponse);
                    } else {
                        callback([]);
                    }
                }, {once: true});

                if (params.sortOrders === undefined || params.sortOrders.length < 1) {
                    getResultPage.params = {
                        'index': params.page,
                        'page_size': params.pageSize
                    };
                } else {
                    getResultPage.params = {
                        'index': params.page,
                        'page_size': params.pageSize,
                        'sort_property': params.sortOrders[0].path,
                        'sort_direction': params.sortOrders[0].direction
                    };
                }
                if (getResultMetadata.lastResponse) {
                    getResultPage.generateRequest();
                }
            };

            getResultMetadata.generateRequest();
        }

        getItem(column, item) {
            if (column !== undefined && item !== undefined && item !== null) {
                return item[column.toLowerCase()];
            }
            return null;
        }
    }

    window.customElements.define(VolumetricResults.is, VolumetricResults);
    </script>
</dom-module>
