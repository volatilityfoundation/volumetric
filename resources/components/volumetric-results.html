<link rel="import" href="/resources/bower_components/polymer/polymer-element.html">
<link rel="import" href="/resources/bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="/resources/bower_components/paper-card/paper-card.html">
<link rel="import" href="/resources/bower_components/vaadin-grid/vaadin-grid.html">

<dom-module id="volumetric-results">
    <template>
    <style>
      :host {
          display: block;

          padding: 10px;
      }

      paper-card {
          width: 100%;
      }
    </style>

        <iron-ajax id="getResultColumns" url="/api/results/columns" last-response="{{columns}}"></iron-ajax>
        <iron-ajax id="getResultPage" url="/api/results/get?job_id=[[jobId]]"></iron-ajax>

        <paper-card id="displayCard" heading="Partial Results">
            <vaadin-grid id="grid">
                <template is="dom-repeat" items="{{columns}}" as="column">
                    <vaadin-grid-column>
                        <template class="header">[[column.name]]</template>
                        <template>[[get(column.name,item)]]</template>
                    </vaadin-grid-column>
                </template>
            </vaadin-grid>
        </paper-card>

    </template>

    <script>
    class VolumetricResults extends Polymer.Element {
        static get is() {
            return 'volumetric-results';
        }

        static get properties() {
            return {
                'page': {
                    type: String,
                    observer: '_refresh',
                    notify: true
                },
                'jobId': {
                    type: String,
                    notify: true
                },
            }
        }

        _refresh() {
            this.$.displayCard.heading = "Partial Results";
        }

        buildGrid() {
            let getResultPage = this.$.getResultPage;
            let getResultColumns = this.$.getResultColumns;
            let grid = this.$.grid;

            getResultColumns.params = {'job_id': this.jobId};
            getResultColumns.addEventListener('response', function() {
                getResultPage.generateRequest();
            }, {once: true});

            grid.size = 20;
            grid.dataProvider = function(params, callback) {
                getResultPage.addEventListener('response', function() {
                    if (getResultPage.lastResponse != undefined) {
                        callback(getResultPage.lastResponse);
                    } else {
                        callback([]);
                    }
                }, {once: true});

                if (grid.sortOrder === undefined || grid.sortOrder.length < 1) {
                    getResultPage.params = {
                        'index': params.page,
                        'page_size': params.pageSize
                    };
                } else {
                    getResultPage.params = {
                        'index': params.page,
                        'page_size': params.pageSize,
                        'sort_property': grid.columns[grid.sortOrder[0].column].name,
                        'sort_direction': grid.sortOrder[0].direction
                    };
                }
                if (getResultColumns.lastResponse) {
                    getResultPage.generateRequest();
                }
            };


            getResultColumns.generateRequest();
        }
    }

    window.customElements.define(VolumetricResults.is, VolumetricResults);
    </script>
</dom-module>
